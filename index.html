<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœƒè­°å®¤é å®š</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        .modal-overlay { z-index: 50; }
        .modal { z-index: 100; }
        .fc-event-time { display: none !important; } /* éšè— FullCalendar é»˜è®¤çš„æ—¶é—´ */
        html, body {
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6; /* âœ… æä¾›æ·¡è‰²èƒŒæ™¯ */
        }
        
        .container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            margin-bottom: 3px;

        }
        
        #calendar-container {
            flex-grow: 1; /* âœ… è®“æ—¥æ›†è‡ªé©æ‡‰å®¹å™¨å¤§å° */
            width: 100%;
            height: calc(100vh - 50px); /* âœ… ä¿æŒåœ¨è¦–çª—å…§ */
        }
        /* âœ… RWD è®“æ—¥æ›†åœ¨å°è¢å¹•ç¸®æ”¾ */
        @media (max-width: 768px) {
            #calendar-container {
                height: calc(100vh - 80px); /* ğŸ“± é¿å…è¶…å‡ºè¢å¹• */
            }
            .fc-toolbar {
                font-size: 0.8rem; /* ğŸ“± ç¸®å°å·¥å…·æ¬„å­—é«” */
            }
            .fc-daygrid-event {
                font-size: 0.7rem; /* ğŸ“± ç¸®å°äº‹ä»¶å­—é«” */
            }
        }
    </style>

</head>
<body class="bg-gray-100 p-6">
    <div class="container mx-auto p-6">
        <!-- é€‰é¡¹å¡ -->
        <div class="flex border-b">
            <button class="tab-btn px-4 py-2 focus:outline-none bg-blue-500 text-white" onclick="switchTab('A101')">A101</button>
            <button class="tab-btn px-4 py-2 focus:outline-none bg-red-500  text-white" onclick="switchTab('A102')">A102</button>
            <button class="tab-btn px-4 py-2 focus:outline-none bg-green-500 text-white" onclick="switchTab('A103')">A103</button>
        </div>
    
        <!-- æ—¥å† -->
        <div id="calendar-container" class="mt-4">
            <div id="A101-calendar" class="calendar hidden"></div>
            <div id="A102-calendar" class="calendar hidden"></div>
            <div id="A103-calendar" class="calendar hidden"></div>
        </div>
    </div>
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-40" onclick="closeAllModals()"></div>
    
    <!-- é ç´„è³‡è¨Š Modal -->
    <div id="eventModal" class="modal hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl w-full max-w-md transition-all scale-95 opacity-0 z-50">
        <h3 class="text-lg font-semibold mb-3">å·²é ç´„</h3>
        <ul id="eventList" class="mt-2 text-sm"></ul>
        <div class="flex justify-between mt-4">
            <button class="bg-gray-400 text-white px-4 py-2 rounded w-1/2 mx-1 hover:bg-gray-500 transition" onclick="closeModal('eventModal')">å…³é—­</button>
            <button class="bg-blue-600 text-white px-4 py-2 rounded w-1/2 mx-1 hover:bg-blue-700 transition" onclick="openModal('bookingModal')">æ–°å¢é¢„çº¦</button>
        </div>
    </div>
    
    <!-- æ–°å¢é ç´„ Modal -->
    <div id="bookingModal" class="modal hidden fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-xl w-full max-w-md transition-all scale-95 opacity-0 z-50">
        <h3 class="text-lg font-semibold mb-4">æ–°å¢é ç´„</h3>
    
        <label class="block text-left font-medium">é è¨‚äººå§“å:</label>
        <input type="text" id="userInput" class="border rounded px-3 py-2 w-full mb-2" placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å">
    
        <label class="block text-left font-medium">é¸æ“‡æ—¥æœŸ:</label>
        <input type="text" id="selectedDate" class="border rounded px-3 py-2 w-full mb-2 bg-white cursor-pointer" placeholder="è«‹é¸æ“‡æ—¥æœŸ">
    
        <label class="block text-left font-medium">é¸æ“‡æœƒè­°å®¤:</label>
        <select id="roomSelect" class="border rounded px-3 py-2 w-full mb-2">
            <option value="A101">A101</option>
            <option value="A102">A102</option>
            <option value="A103">A103</option>
        </select>
    
        <label class="block text-left font-medium">é–‹å§‹æ™‚é–“:</label>
        <input type="text" id="startTimePicker" class="border rounded px-3 py-2 w-full mb-2 bg-white cursor-pointer" placeholder="è«‹é¸æ“‡é–‹å§‹æ™‚é–“">
    
        <label class="block text-left font-medium">çµæŸæ™‚é–“:</label>
        <input type="text" id="endTimePicker" class="border rounded px-3 py-2 w-full mb-2 bg-white cursor-pointer" placeholder="è«‹é¸æ“‡çµæŸæ™‚é–“">
    
        <p id="errorMessage" class="text-red-500 text-sm mt-2 hidden">è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼Œä¸”ç¢ºä¿çµæŸæ™‚é–“æ™šæ–¼é–‹å§‹æ™‚é–“ã€‚</p>
    
        <div class="flex justify-between mt-4">
            <button class="bg-gray-400 text-white px-4 py-2 rounded w-1/2 mx-1 hover:bg-gray-500 transition" onclick="closeModal('bookingModal')">å–æ¶ˆ</button>
            <button class="bg-green-600 text-white px-4 py-2 rounded w-1/2 mx-1 hover:bg-green-700 transition" onclick="submitBooking()">æäº¤</button>
        </div>
    </div>
        
    <script>
        let calendars = {}; // âœ… ç¢ºä¿é€™å€‹è®Šæ•¸åœ¨æ‰€æœ‰å‡½æ•¸ä¸­éƒ½å¯ä»¥ä½¿ç”¨
        let activeCalendar = null; // è¨˜éŒ„ç•¶å‰é¡¯ç¤ºçš„æ—¥æ›†

        //const API_URL = "http://localhost:8000/api/bookings";
        const API_URL = "https://meetingbooking.deno.dev/api/bookings";    

        function getRoomColor(room) {
            const colors = { "A101": "blue", "A102": "red", "A103": "green" };
            return colors[room] || "gray";
        }
        async function fetchEvents(room) {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                return data.data
                    .filter(event => event.room === room) // åªé¡¯ç¤ºç›®å‰æœƒè­°å®¤çš„é ç´„
                    .map(event => ({
                        title: `${formatTime(event.startTime)}~${formatTime(event.endTime)}`,
                        start: event.startTime,
                        end: event.endTime,
                        backgroundColor: getRoomColor(event.room),
                    }));
            } catch (err) {
                console.error("è·å–æ—¥å†æ•°æ®å¤±è´¥:", err);
                return [];
            }
        }
        
        document.addEventListener("DOMContentLoaded", async function () {
            await renderCalendar("A101");
        });
        async function renderCalendar(room) {
            const calendarEl = document.getElementById(`${room}-calendar`);
            
            if (!calendarEl) {
                console.error(`âŒ ç„¡æ³•æ‰¾åˆ°æ—¥æ›†å…ƒç´ : ${room}-calendar`);
                return;
            }

            let initialView = "timeGridWeek";
            if (window.innerWidth < 768) {
                initialView = "timeGridDay"; // ğŸ“± æ‰‹æ©Ÿä¸Šé¡¯ç¤ºå–®æ—¥è¦–åœ–
            }
        
        
            if (!calendars[room]) {
                calendars[room] = new FullCalendar.Calendar(calendarEl, {
                    initialView: "timeGridWeek",
                    height: "auto",
                    contentHeight: "100%", // âœ… ç¢ºä¿æ—¥æ›†ä¸æœƒè¶…å‡ºè¢å¹•
                    aspectRatio: 1.35, // âœ… æ§åˆ¶å¯¬é«˜æ¯”ä¾‹ï¼Œç¢ºä¿åœ¨æ‰‹æ©Ÿä¸Šä¸æœƒå¤ªæ“         
                    expandRows: true,
                    nowIndicator: true,
                    slotMinTime: "08:00:00",
                    slotMaxTime: "19:00:00",
                    slotDuration: window.innerWidth < 768 ? "01:00:00" : "00:30:00", // ğŸ“± åœ¨æ‰‹æ©Ÿä¸Šå¢åŠ æ™‚æ®µé–“éš”ï¼Œé¿å…æ ¼å­éå¤š
                    slotDuration: "00:30:00",
                    slotLabelInterval: "01:00:00",
                    headerToolbar: {
                        left: "prev,next today",
                        center: "title",
                        right: "dayGridMonth,timeGridWeek,timeGridDay" // ğŸ“± æ‰‹æ©Ÿä¸Šåªé¡¯ç¤º `timeGridDay`
                        
                    },
                    events: async function(fetchInfo, successCallback, failureCallback) {
                        const events = await fetchEvents(room);
                        successCallback(events);
                    },
                    dateClick: async function(info) {
                        const clickedDateTime = new Date(info.date);
                    
                        if (info.view.type === "dayGridMonth") {
                            // âœ… åœ¨ã€Œæœˆæ›†æ¨¡å¼ã€ä¸‹ï¼Œé¡¯ç¤ºç•¶å¤©æ‰€æœ‰é ç´„
                            const events = await fetchEvents(activeCalendar.room);
                            const eventsForTheDay = events.filter(event => event.start.startsWith(formattedDate));
                    
                            document.querySelector("#eventModal h3").innerText = `å·²é ç´„ - ${formattedDate}`;
                            const eventListEl = document.getElementById("eventList");
                            eventListEl.innerHTML = "";
                    
                            if (eventsForTheDay.length === 0) {
                                eventListEl.innerHTML = "<p class='text-gray-500'>ç•¶å¤©ç„¡é ç´„</p>";
                            } else {
                                eventsForTheDay.forEach(event => {
                                    const listItem = document.createElement("li");
                                    listItem.innerHTML = `<strong>${event.title}</strong>`;
                                    eventListEl.appendChild(listItem);
                                });
                            }
                    
                            openModal("eventModal"); // âœ… é¡¯ç¤ºé ç´„æ¸…å–®
                        } else {
                            const formattedDate = clickedDateTime.toISOString().split("T")[0]; // YYYY-MM-DD
                            const formattedTime = clickedDateTime.toTimeString().slice(0, 5); // HH:MM
    
                            // âœ… åœ¨ã€Œé€±æ›†/æ—¥æ›†æ¨¡å¼ã€ä¸‹ï¼Œå¡«å…¥æ™‚é–“ä¸¦é–‹å•Ÿé ç´„è¡¨å–®
                            document.getElementById("selectedDate").value = formattedDate;
                            document.getElementById("startTimePicker").value = formattedTime;
                    
                            const endDateTime = new Date(clickedDateTime.getTime() + 30 * 60000);
                            const formattedEndTime = endDateTime.toTimeString().slice(0, 5);
                            document.getElementById("endTimePicker").value = formattedEndTime;
                    
                            //document.getElementById("roomSelect").value = activeCalendar.room;
                    
                            openModal("bookingModal"); // âœ… é–‹å•Ÿé ç´„è¡¨å–®
                        }
                    }
                                        
                });
        
                calendarEl.style.display = "block";
                calendars[room].render();
            } else {
                const newEvents = await fetchEvents(room);
                calendars[room].removeAllEvents();
                calendars[room].addEventSource(newEvents);
                calendars[room].updateSize();
            }
        }
                
                        
        function switchTab(room) {
            document.getElementById("roomSelect").value = room;
            document.querySelectorAll(".calendar").forEach(el => el.classList.add("hidden"));
        
            // âœ… ç¢ºä¿ fetchEvents() å·²ç¶“å®šç¾©
            renderCalendar(room);
        }
        // åˆå§‹åŒ–æ—¥æœŸé¸æ“‡å™¨ï¼ˆç”¨æ–¼é¡¯ç¤ºé¸ä¸­çš„æ—¥æœŸï¼Œä¸å…è¨±æ‰‹å‹•é¸æ“‡ï¼‰
        flatpickr("#startTimePicker", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true,
            minTime: "08:00",
            maxTime: "18:00",
            onChange: function(selectedDates) {
                if (selectedDates.length > 0) {
                    document.getElementById("endTimePicker")._flatpickr.set("minTime", selectedDates[0].toTimeString().slice(0, 5));
                }
            }
        });
        
        flatpickr("#endTimePicker", {
            enableTime: true,
            noCalendar: true,
            dateFormat: "H:i",
            time_24hr: true,
            minTime: "08:00",
            maxTime: "18:00",
            onChange: function(selectedDates) {
                const start = document.getElementById("startTimePicker")._flatpickr.selectedDates[0];
                if (start && selectedDates[0] <= start) {
                    alert("çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼");
                    document.getElementById("endTimePicker")._flatpickr.clear();
                }
            }
        });

        window.addEventListener("resize", () => {
            Object.keys(calendars).forEach(room => {
                calendars[room]?.updateSize();
            });
        });

        function switchTab(room) {
            document.getElementById("roomSelect").value = room;
        
            document.querySelectorAll(".calendar").forEach(el => {
                el.style.display = "none";
            });
        
            const newCalendar = document.getElementById(`${room}-calendar`);
            newCalendar.style.display = "block";
        
            renderCalendar(room);
        
            // âœ… è®“ FullCalendar åœ¨åˆ‡æ›æˆ¿é–“æ™‚è‡ªé©æ‡‰
            setTimeout(() => {
                calendars[room]?.updateSize();
            }, 300);
        }
        
        // æ›´æ–°æ™‚é–“é¸æ“‡å™¨
        function updateTimePickers() {
            const startTimePicker = document.getElementById("startTimePicker")._flatpickr;
            const endTimePicker = document.getElementById("endTimePicker")._flatpickr;
        
            if (selectedDate) {
                startTimePicker.set("minTime", "08:00");
                startTimePicker.set("maxTime", "18:00");
                endTimePicker.set("minTime", "08:00");
                endTimePicker.set("maxTime", "18:00");
                startTimePicker.setDate(""); // æ¸…ç©ºå…ˆå‰é¸æ“‡çš„æ™‚é–“
                endTimePicker.setDate("");   // æ¸…ç©ºå…ˆå‰é¸æ“‡çš„æ™‚é–“
            }
        }
        
        // æäº¤é è¨‚
        async function submitBooking() {
            const user = document.getElementById("userInput").value.trim();
            const room = document.getElementById("roomSelect").value;
            const selectedDate = document.getElementById("selectedDate").value;
            const startTime = document.getElementById("startTimePicker").value;
            const endTime = document.getElementById("endTimePicker").value;            
            const errorMessage = document.getElementById("errorMessage");
        
            if (!selectedDate) {
                errorMessage.innerText = "è«‹å…ˆé¸æ“‡æ—¥æœŸï¼";
                errorMessage.classList.remove("hidden");
                return;
            }
        
            if (!user || !room || !startTime || !endTime) {
                errorMessage.innerText = "è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½ï¼";
                errorMessage.classList.remove("hidden");
                return;
            }
        
            const start = new Date(`${selectedDate}T${startTime}:00`);
            const end = new Date(`${selectedDate}T${endTime}:00`);
            
            // âœ… ç¢ºä¿ `start` å’Œ `end` éƒ½æ˜¯æœ‰æ•ˆçš„ `Date`
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                errorMessage.innerText = "ç„¡æ•ˆçš„æ™‚é–“æ ¼å¼ï¼Œè«‹é‡æ–°é¸æ“‡ï¼";
                errorMessage.classList.remove("hidden");
                return;
            }

            if (start >= end) {
                errorMessage.innerText = "çµæŸæ™‚é–“å¿…é ˆæ™šæ–¼é–‹å§‹æ™‚é–“ï¼";
                errorMessage.classList.remove("hidden");
                return;
            }
        
            errorMessage.classList.add("hidden");
        
            const bookingData = { user, room, startTime: start.toISOString(), endTime: end.toISOString() };
        
            try {
                const response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(bookingData)
                });
        
                const result = await response.json();
                if (result.error) {
                    alert("é è¨‚å¤±æ•—: " + result.error);
                } else {
                    alert("é è¨‚æˆåŠŸ âœ…");
                    // âœ… å›å‚³é ç´„è³‡è¨Šçµ¦ LINE Chatbot
                    if (liff.isInClient()) {
                        liff.sendMessages([
                            {
                                type: "text",
                                text: `âœ… é ç´„æˆåŠŸï¼\nğŸ“… æ—¥æœŸ: ${selectedDate}\nğŸ•’ æ™‚é–“: ${startTime} - ${endTime}\nğŸ¢ æœƒè­°å®¤: ${room}`
                            }
                        ]).then(() => {
                            liff.closeWindow(); // âœ… å®Œæˆå¾Œé—œé–‰ LIFF
                        }).catch((err) => {
                            console.error("å‚³é€è¨Šæ¯å¤±æ•—:", err);
                        });
                    }
                    closeModal('bookingModal');
                    location.reload();
                }
            } catch (error) {
                alert("æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ï¼");
            }
        }
        
        function formatTime(isoString) {
            const date = new Date(isoString);
            return date.toLocaleTimeString("zh-TW", { timeZone: "Asia/Taipei", hour: "2-digit", minute: "2-digit", hourCycle: "h23" });
        }

        function openModal(id) {
            document.getElementById("overlay").classList.remove("hidden");
            const modal = document.getElementById(id);
            modal.classList.remove("hidden", "scale-95", "opacity-0");
            modal.classList.add("scale-100", "opacity-100");
                }

        function closeModal(id) {
            document.getElementById("overlay").classList.add("hidden");
            const modal = document.getElementById(id);
            modal.classList.add("scale-95", "opacity-0");
            setTimeout(() => modal.classList.add("hidden"), 200); // åŠ å»¶é²ç¢ºä¿å‹•ç•«åŸ·è¡Œ
        }

        function closeAllModals() {
            document.querySelectorAll(".modal").forEach(modal => modal.classList.add("hidden"));
            document.getElementById("overlay").classList.add("hidden");
        }
    </script>
</body>
</html>
